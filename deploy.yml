---
- hosts: localhost
  connection: local
  tasks:
    - name: Pull the latest code from the GitHub repository
      git:
        repo: 'https://github.com/paju3125/Flask-App.git'
        dest: /home/runner/work/Flask-App/deploy/Flask_App
        version: master

    - name: Create a virtual environment using venv
      command: python3 -m venv /home/runner/work/Flask-App/deploy/Flask_App/venv
      args:
        creates: /home/runner/work/Flask-App/deploy/Flask_App/venv/bin/activate

    - name: Install dependencies
      command: /home/runner/work/Flask-App/deploy/Flask_App/venv/bin/pip install -r /home/runner/work/Flask-App/deploy/Flask_App/requirements.txt

    - name: Start the Flask application
      command: >
        nohup /home/runner/work/Flask-App/deploy/Flask_App/venv/bin/python /home/runner/work/Flask-App/deploy/Flask_App/app.py
        > /home/runner/work/Flask-App/deploy/Flask_App/app.log 2>&1 &
      args:
        chdir: /home/runner/work/Flask-App/deploy/Flask_App

    - name: Wait for Flask to start
      command: sleep 10
